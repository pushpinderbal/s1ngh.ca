---
layout: post
title:  "Foreman and Smart-Proxy Installation"
author: "Pushpinder"
date:   2019-02-10 21:35:31 +0000
tags: ["foreman", "automation"]
---

> **Foreman is an open source project that helps system administrators manage servers throughout their life cycle, from provisioning and configuration to orchestration and monitoring. Provisioning support gives you easy control of setting up new servers, and using configuration management (Puppet, Ansible, Chef and Salt are supported), you can easily automate repetitive tasks. With Foreman, you can quickly deploy applications, and proactively manage change, both on-premise with VMs and bare-metal or in the cloud. Foreman scales well to multiple locations (offices, data centers, etc) and multiple organisations, allowing you to grow without losing your single source of infrastructure truth.**

**The operations described in this document were performed on the following equipment:**

<table border="1" id="bkmrk-os-specifications-fu" style="border-collapse: collapse; width: 100%; height: 87px;"><tbody><tr style="height: 29px; background-color: #86dab9;"><td class="align-center" style="width: 36.0677%; height: 29px;">**OS**</td><td class="align-center" style="width: 37.636%; height: 29px;">**Specifications**</td><td class="align-center" style="width: 32.3457%; height: 29px;">**Functions**</td></tr><tr style="height: 29px;"><td style="width: 36.0677%; height: 29px;">CentOS Linux release 7.7.1908

</td><td style="width: 37.636%; height: 29px;">Virtual Machine - 2 CPU, 2GB RAM, 20GB Disk</td><td style="width: 32.3457%; height: 29px;">Foreman Server, Puppet Master, Puppet CA, TFTP Proxy</td></tr><tr style="height: 29px;"><td style="width: 36.0677%; height: 29px;">Windows Server 2019 Datacenter Edition</td><td style="width: 37.636%; height: 29px;">Virtual Machine - 4 CPU, 8GB RAM, 60GB Disk</td><td style="width: 32.3457%; height: 29px;">Domain Controller for bal.com, DNS &amp; DHCP Server + Smart-Proxies.</td></tr></tbody></table>

### Install Foreman with Puppet Master

- Perform a clean installation of a CentOS system. Make sure that you have **sudo** access to the system before moving on to the next steps.
- For simplicity's sake, disable firewalld and SELinux. This can be enabled later after having a working setup.

{% highlight shell %}
systemctl stop firewalld
systemclt disable firewalld
vi /etc/selinux/config
	#change the SELINUX= value to disabled
	SELINUX=disabled
{% endhighlight %}

- The foreman installer requires puppet. Foreman installations depend upon a back-end **database**, which is installed as part of the installer. Enable the required repositories for Puppet and Foreman.

{% highlight shell %}
sudo yum -y install https://yum.puppet.com/puppet6-release-el-7.noarch.rpm
sudo yum -y install http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
sudo yum -y install https://yum.theforeman.org/releases/1.23/el7/x86_64/foreman-release.rpm
{% endhighlight %}

- Install and run the foreman-installer. Additionally, if this server is being setup as a sub-node to a Master Puppet/Foreman server or it only requires select functions to be installed, you can choose to pass command line arguments to the installer command. More information for doing an interactive/custom foreman installation can be found [here](https://theforeman.org/manuals/1.23/index.html#3.2.2InstallerOptions). A full foreman install includes all the packaged Proxies, Puppet and Foreman.

{% highlight shell %}
sudo yum -y install foreman-installer
sudo foreman-installer
{% endhighlight %}

When the installation is complete you should have a message similar to:

{% highlight shell %}
* Foreman is running at https://foreman-01.bal.com
    Initial credentials are admin / d8fds39fjd2Fdo
* Foreman Proxy is running at https://theforeman.example.com:8443
* Puppetmaster is running at port 8140
The full log is at /var/log/foreman-installer/foreman-installer.log
{% endhighlight %}

In it's default configuration:

- Foreman Server runs on port 443(HTTPS).
- Foreman-Proxy runs on port 8443. All connections made to a destination foreman proxy are at port 8443.
- Puppet Master server runs on port 8140.

### Foreman Configuration -&gt; /etc/foreman/settings.yaml

Ensure the following options:

<table border="1" id="bkmrk-%3Aunattended%3A-true-%23-" style="border-collapse: collapse; width: 62.3541%; height: 55px;"><tbody><tr><td style="width: 100%;">`:unattended:   true`

`# The following option is by default set to true, but to make `

`# Windows deployment easier later in the guide, we will set it as false.`

`:require_ssl:  false`

`:puppetrun:    false`

</td></tr></tbody></table>

Use the same certificates and keys generated by puppet ,for both the Websockets and SSL-settings.

The following components are now up running on the CentOS VM:

<table border="1" id="bkmrk-puppet-puppet-ca-%28pu" style="border-collapse: collapse; width: 80.3703%; height: 73px;"><tbody><tr style="height: 73px;"><td style="width: 46.9137%; height: 73px;">- Puppet
- Puppet CA (Puppet Certificate Management Server)
- TFTP

</td><td style="width: 33.5646%; height: 73px;">- Foreman
- Foreman-proxies (pre-configured Puppet, Puppet CA and TFTP).

</td></tr></tbody></table>

Next, we will install and configure the DHCP and DNS proxies on Windows Server 2019.

### Install MS DNS &amp; DHCP Smart-Proxy on Windows Server

In order to use Microsoft DNS and DHCP services in conjunction with Foreman, a smart-proxy must be installed on a **Windows** machines strictly, and configured to be talking to the MS Servers and Foreman. It is not essential for the proxy to be on the same machine as the DNS/DHCP servers, but it must be a Windows Server Host. Following are the steps to install Windows Smart-Proxy.

- Download the latest available Ruby+DevKit package for Windows from [this link](https://rubyinstaller.org/downloads/).
- Run the installer, and specify the following:

<table border="1" id="bkmrk-make-sure-to-check-t" style="border-collapse: collapse; width: 100%;"><tbody><tr><td style="width: 29.6295%;">![](https://s1ngh.ca/images/image-1571534849483.png)

**Make sure to Check the box for adding Ruby executables to the PATH variable.**

</td><td style="width: 29.8149%;">![](https://s1ngh.ca/images/image-1571534857528.png)

**Select the Development Toolchain as part of the install.**

</td><td style="width: 28.6729%;">![](https://s1ngh.ca/images/image-1571535244877.png)

**Select the checkbox and Finish. On the next screen press Enter and the DevKit extensions will be installed.**

</td></tr></tbody></table>

- Download/Clone the Smart-Proxy from the [git source.](https://github.com/theforeman/smart-proxy)

![](https://s1ngh.ca/images/image-1571535131985.png)

- Extract the Downloaded ZIP file to C:\\smart-proxy-develop.
- Next, open an administrative Command Prompt and run the following commands to complete the installation.

{% highlight powershell %}
cd c:\smart-proxy-develop
gem install --no-ri --no-rdoc bundler
bundle install --without development test krb5 puppet_proxy_legacy bmc libvirt
{% endhighlight %}

![](https://s1ngh.ca/images/image-1571536593285.png)

### Configure Windows Smart-Proxy

- Generate Certificates for the smart-proxy on the Puppet CA server. 
    - *puppet cert generate server-proxy.bal.com*
- Copy the proxy's **private key** and **certificate file** plus the **ca.pem** file from the Puppet Master to a location on the Smart Proxy server(C:\\smart-proxy-develop\\ssl) 
    - Files: /*etc/puppetlabs/puppet/ssl/certs/server-proxy.bal.com.pem, /etc/puppetlabs/puppet/ssl/certs/ca.pem, /etc/puppetlabs/puppet/ssl/private\_keys/server\_dc.bal.com.pem*![](https://s1ngh.ca/images/image-1571537238761.png)
- Run the following commands in a command prompt to create valid configuration files for the feature to enable, which we will later edit.

**Note: If you wish to enable any other features than DHCP and DNS on this proxy simply remove the .example part from the appropriate config file for that feature.**

{% highlight shell %}
cd c:\smart-proxy-develop\config
cp settings.yml.example settings.yml
cp settings.d\dhcp.yml.example settings.d\dhcp.yml
cp settings.d\dhcp_native_ms.yml.example settings.d\dhcp_native_ms.yml
cp settings.d\dns.yml.example settings.d\dns.yml
cp settings.d\dns_dnscmd.yml.example settings.d\dns_dnscmd.yml
{% endhighlight %}

- Make changes to the newly created configuration files as desired. **Following examples only show the changes:**

{% highlight YAML %}
-------settings.yml-------
:ssl_certificate: C:\smart-proxy-develop\ssl\certs\server-proxy.bal.com.pem
:ssl_ca_file: C:\smart-proxy-develop\ssl\certs\ca.pem
:ssl_private_key: C:\smart-proxy-develop\ssl\keys\server-proxy.bal.com.pem
#Enter the value for the Foreman Server
:foreman_url: https://172.16.1.9

---------dhcp.yml---------
:enabled: true
:use_provider: dhcp_native_ms
#Enter the DHCP Server IP Address
:server: 127.0.0.1

---------dns.yml----------
:enabled: true
:use_provider: dns_dnscmd
{% endhighlight %}

- Register the Smart-Proxy daemon as a <span style="text-decoration: underline;">Windows Service</span> and enable it to run on boot.

<table border="1" id="bkmrk-open-command-prompt%2C" style="border-collapse: collapse; width: 100%;"><tbody><tr><td style="width: 32.3951%;">*Open Command Prompt,*

{% highlight shell %}
cd c:\smart-proxy-develop<br></br>ruby extra\register-service.rb
{% endhighlight %}

</td><td style="width: 35.8148%;">*Open services.msc,*

![](https://s1ngh.ca/images/image-1571538929316.png)

</td><td style="width: 32.3283%;">*Add the credentials for the domain admin user account.*

![](https://s1ngh.ca/images/image-1571539033794.png)

</td></tr></tbody></table>

- As the last step, add the Proxy to the Foreman Server.

![](https://s1ngh.ca/images/image-1571539494287.png)

**Smart-Proxy Status:**

![](https://s1ngh.ca/images/image-1571539612308.png)